<!doctype>
<html>
  <head>
    <title>Drink Mixer!</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        var ENDPOINT = "https://localhost:8880";

        function showstatus(s) {
          $("#status").html(s);
        }

        var tryagain = true;

        showstatus("Click the button to make a drink!")
        var recognition = new webkitSpeechRecognition();
        recognition.onstart = function() {
          showstatus("What drink would you like? speak now...");
          tryagain = true;
        }
        recognition.onend = function() {
          showstatus("done. try again!");
          if (tryagain) {
            $.get(ENDPOINT + "/unknown");
          }
          tryagain = false;
        }
        recognition.onerror = function(event) {
          if (event.error == "no-speech") {
            showstatus("error: no speech");
          }
          if (event.error == "audio-capture") {
            showstatus("error: audio capture");
          }
          if (event.error == "not-allowed") {
            if (event.timeStamp - start_timestamp < 100) {
              showstatus("error: blocked");
            } else {
              showstatus("error: denied");
            }
          }
        }

        // Send ALL the results to the server
        // and let the server choose the drink.
        recognition.onresult = function(event) {
          tryagain = false;
          console.log(event);
          var best_text = "";
          var best_confidence = -1.0;
          var guesses = new Array();
          for (var i = 0; i < event.results.length; i++) {
            var result = event.results[i];
            for (var j = 0; j < result.length; j++) {
              var choice = result[j];
              var confidence = choice["confidence"];
              var transcript = choice["transcript"];
              $("#results").prepend("<li>" + transcript + ", " + confidence + "</li>");
              if (confidence > best_confidence) {
                best_confidence = confidence;
                best_text = transcript;
              }
              var guess = {"text": transcript, "confidence": confidence};
              guesses.push(guess);
            }
          }

          if (best_text != "") {
            var request = {values: guesses};
            var requeststr = JSON.stringify(request);
            console.log(requeststr);
            $.ajax({
              type: "POST",
              url: ENDPOINT + "/speech",
              data: requeststr,
              dataType: "json",
            });
          } else {
            $.get(ENDPOINT + "/unknown");
          }
        };

        $("#button").click(function(e) {
          $.get(ENDPOINT + "/start", function() {
            recognition.start();
          });
          showstatus("allow chrome access to mic");
        });

        // grab drink menu
        $.ajax({
          type: "GET",
          url: ENDPOINT + "/drinks",
          dataType: "json",
          success: function(data) {
            console.log(data);
            for (var drink in data) {
              $("#drinks").append("<li><button class='order'>" + drink + "</button></li>");
            }
            $(".order").click(function(e) {
              var guesses = new Array();
              var transcript = $(this).text();
              var confidence = 1.0;
              guesses.push({text: transcript, confidence: confidence});
              var request = {values: guesses};
              var requeststr = JSON.stringify(request);
              console.log(requeststr);
              $.ajax({
                type: "POST",
                url: ENDPOINT + "/speech",
                data: requeststr,
                dataType: "json",
              });
              $("#results").prepend("<li>" + transcript + ", " + confidence + "</li>");
            });
          },
        });
      });
    </script>
  </head>
  <body>
    <div>
      <h1>Drink Menu:</h1>
      <ul id="drinks"></ul>
    </div>
    <h1 id="status"></h1>
    <input id="button" type="button" value="Click to speak">
    <div>
      <h1>Order History:</h1>
      <ul id="results"></ul>
    </div>
  </body>
</html>
